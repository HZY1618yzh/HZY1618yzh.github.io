<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆ|æµ·é¾Ÿæ±¤</title>
    <script>
        document.title = 'Loding... æ¸¸æˆ|æµ·é¾Ÿæ±¤';
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="/css/sidebar.css" crossorigin="anonymous">
    <script src="/js/sidebar.js"></script>
    <link rel="icon" href="https://cdn.luogu.com.cn/upload/usericon/1394471.png" type="image/png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .link-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            transition: transform 0.3s;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .link-card a {
            position: relative;
            z-index: 1;
            color: black !important;
            font-weight: bold;
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .link-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .special-card {
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            position: relative;
            overflow: hidden;
            border: 2px solid #ff5252;
            box-shadow: 0 4px 20px rgba(255, 82, 82, 0.4);
        }

        .special-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(45deg,
                    transparent,
                    transparent 10px,
                    rgba(255, 255, 255, 0.1) 10px,
                    rgba(255, 255, 255, 0.1) 20px);
            animation: shine 3s infinite linear;
            z-index: 0;
        }

        .special-card a {
            position: relative;
            z-index: 1;
            color: white !important;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .special-card img {
            filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.5));
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }

        @keyframes shine {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .version-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 0.9em;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .version-table thead tr {
            background-color: #4a6cf7;
            color: #ffffff;
            text-align: left;
        }

        .version-table th,
        .version-table td {
            padding: 12px 15px;
        }

        .version-table tbody tr {
            border-bottom: 1px solid #dddddd;
        }

        .version-table tbody tr:nth-of-type(even) {
            background-color: #f8f9fa;
        }

        .version-table tbody tr:last-of-type {
            border-bottom: 2px solid #4a6cf7;
        }

        .version-table tbody tr:hover {
            background-color: #f1f3f5;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-not-supported {
            background-color: #ff6b6b;
            color: white;
        }

        .game-description {
            text-align: center;
            margin-bottom: 30px;
            color: #4a5568;
        }
    </style>
</head>

<body>
    <div id="nav"></div>
    <main style="padding: 20px;">
        <h1>æµ·é¾Ÿæ±¤æ¸¸æˆ</h1>
        <div class="link-card special-card">
            <a href="https://download.hzy.us.kg/hgt.exe" download>
                <i class="fas fa-download" style="margin-right: 10px;"></i>
                ç«‹å³ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ï¼ˆgithubæ…¢é€Ÿç‰ˆï¼‰
            </a>
        </div>
        <div class="link-card">
            <h2><i class="fas fa-info-circle"></i> æ¸¸æˆä»‹ç»</h2>
            <p>æµ·é¾Ÿæ±¤æ˜¯ä¸€æ¬¾ç»å…¸çš„ç›Šæ™ºæ¸¸æˆï¼Œç©å®¶éœ€è¦é€šè¿‡æé—®é—®é¢˜æ¥æ¢ç´¢æ±¤åº•ã€‚</p>
            <p>æ¸¸æˆç‰¹ç‚¹ï¼š</p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>é”»ç‚¼é€»è¾‘æ€ç»´</li>
                <li>ç®€å•æ˜“ä¸Šæ‰‹ï¼Œéš¾ç²¾é€š</li>
                <li>å¯ä»¥é€‚å½“æç¤ºå’Œè·å–ç­”æ¡ˆ</li>
            </ul>
        </div>
        <div class="link-card">
            <h2><i class="fas fa-history"></i> ç‰ˆæœ¬å†å²</h2>
            <p>ä»¥ä¸‹æ˜¯æµ·é¾Ÿæ±¤æ¸¸æˆçš„ç‰ˆæœ¬æ›´æ–°è®°å½•ï¼š</p>

            <table class="version-table">
                <thead>
                    <tr>
                        <th>ä¸‹è½½é“¾æ¥</th>
                        <th>ç‰ˆæœ¬å·</th>
                        <th>æ›´æ–°å†…å®¹</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="status-badge status-not-supported"><a href="" download>ä¸‹è½½åœ°å€</a></span>
                        </td>
                        <td>1.0</td>
                        <td>api è°ƒç”¨å†…å®¹</td>
                    </tr>
                </tbody>
            </table>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
<style>.hljs {background: #fafafa;padding: 0 !important;line-height: 1.5 !important;}</style>
            <details>
                <summary>ç‚¹å‡»å±•å¼€/æ”¶èµ·æºä»£ç </summary>
<pre style="position:relative;background:#fafafa;border:1px solid #ddd;padding:16px;margin:16px 0;border-radius:6px;overflow-x:auto;font-family:'Courier New',monospace;"><button style="position:absolute;top:8px;right:8px;background:#fafafa;color:#fafafa;border:none;padding:4px 10px;border-radius:4px;font-size:12px;cursor:pointer;line-height:0;height:24px;box-sizing:border-box;transition:all 0.2s ease;" onmouseover="this.style.background='#ddd';this.style.color='#555';" onmouseout="this.style.background='#fafafa';this.style.color='#fafafa';" onclick="const code=this.nextElementSibling.textContent;const textarea=document.createElement('textarea');textarea.value=code;document.body.appendChild(textarea);textarea.select();document.execCommand('copy');document.body.removeChild(textarea);this.innerHTML='<i class=&quot;fas fa-check&quot;></i>';setTimeout(()=>{this.innerHTML='<i class=&quot;fas fa-copy&quot;></i>'},2000)"><i class="fas fa-copy"></i></button><code style="display:block;padding-right:50px;">"""
æ™ºè°±æ¸…è¨€æ™ºèƒ½ä½“APIè°ƒç”¨ - å•ä¼šè¯ç‰ˆæœ¬
ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºä¼šè¯ï¼Œæ•´ä¸ªè¿è¡ŒæœŸé—´ä½¿ç”¨åŒä¸€ä¸ªä¼šè¯
ç¨‹åºé€€å‡ºæ—¶è‡ªåŠ¨ç»“æŸä¼šè¯
"""

import requests
import json
import time
import os
import sys
import atexit
from typing import Optional

class ChatGLMAssistant:
    """æ™ºè°±æ¸…è¨€æ™ºèƒ½ä½“å®¢æˆ·ç«¯ï¼ˆå•ä¼šè¯ç‰ˆæœ¬ï¼‰"""
    
    def __init__(self, api_key: str, api_secret: str, assistant_id: str):
        """
        åˆå§‹åŒ–å¹¶è‡ªåŠ¨åˆ›å»ºä¼šè¯
        
        Args:
            api_key: API Key
            api_secret: API Secret
            assistant_id: æ™ºèƒ½ä½“ID
        """
        self.api_key = api_key
        self.api_secret = api_secret
        self.assistant_id = assistant_id
        self.base_url = "https://chatglm.cn/chatglm/assistant-api/v1"
        self.token = None
        self.token_expiry = 0
        self.conversation_id = None
        self.session_started = False
        
        # æ³¨å†Œé€€å‡ºæ—¶çš„æ¸…ç†å‡½æ•°
        atexit.register(self.cleanup)
        
        # ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–ä¼šè¯
        self._initialize_session()
    
    def _initialize_session(self):
        """ç¨‹åºå¯åŠ¨æ—¶åˆå§‹åŒ–ä¼šè¯"""
        print("ğŸ”„ æ­£åœ¨åˆå§‹åŒ–æ¸¸æˆä¼šè¯...")
        
        # 1. è·å–token
        token = self._get_token()
        if not token:
            print("âŒ æ— æ³•è·å–è®¿é—®ä»¤ç‰Œ")
            sys.exit(1)
        
        # 2. å‘é€åˆå§‹æ¶ˆæ¯æ¥åˆ›å»ºä¼šè¯
        try:
            response = requests.post(
                f"{self.base_url}/stream_sync",
                headers={
                    "Authorization": f"Bearer {token}",
                    "Content-Type": "application/json"
                },
                json={
                    "assistant_id": self.assistant_id,
                    "prompt": "å¼€å§‹æ¸¸æˆ"
                },
                timeout=30
            )
            
            if response.status_code == 200:
                result = response.json()
                if result.get("status") == 0:
                    # è·å–å¹¶ä¿å­˜ä¼šè¯ID
                    result_data = result.get("result", {})
                    self.conversation_id = result_data.get("conversation_id")
                    
                    if self.conversation_id:
                        print(f"âœ… æ¸¸æˆä¼šè¯å·²åˆ›å»º (ID: {self.conversation_id[:16]}...)")
                        self.session_started = True
                        print("ğŸ® æ¸¸æˆä¼šè¯å·²å‡†å¤‡å°±ç»ª")
                    else:
                        print("âŒ æœªèƒ½è·å–ä¼šè¯ID")
                else:
                    print(f"âŒ ä¼šè¯åˆ›å»ºå¤±è´¥: {result.get('message', 'æœªçŸ¥é”™è¯¯')}")
            else:
                print(f"âŒ HTTPé”™è¯¯: {response.status_code}")
                
        except Exception as e:
            print(f"âŒ ä¼šè¯åˆå§‹åŒ–å¤±è´¥: {str(e)}")
            sys.exit(1)
    
    def cleanup(self):
        """ç¨‹åºé€€å‡ºæ—¶æ¸…ç†ä¼šè¯"""
        if not self.session_started:
            return
            
        print("\n" + "=" * 60)
        print("ğŸ§¹ æ­£åœ¨ç»“æŸæ¸¸æˆä¼šè¯...")
        
        try:
            # å‘é€ç»“æŸæ¶ˆæ¯ï¼ˆå¯é€‰ï¼Œè®©æ™ºèƒ½ä½“çŸ¥é“ä¼šè¯ç»“æŸï¼‰
            if self.conversation_id:
                try:
                    token = self._get_token()
                    if token:
                        requests.post(
                            f"{self.base_url}/stream_sync",
                            headers={
                                "Authorization": f"Bearer {token}",
                                "Content-Type": "application/json"
                            },
                            json={
                                "assistant_id": self.assistant_id,
                                "prompt": "æ¸¸æˆç»“æŸï¼Œè°¢è°¢ï¼",
                                "conversation_id": self.conversation_id
                            },
                            timeout=10
                        )
                except:
                    pass  # å¿½ç•¥ç»“æŸæ¶ˆæ¯çš„å‘é€é”™è¯¯
            
            # æ¸…ç†å˜é‡
            self.conversation_id = None
            self.session_started = False
            print("âœ… æ¸¸æˆä¼šè¯å·²ç»“æŸ")
            
        except Exception as e:
            print(f"âš ï¸  æ¸…ç†æ—¶å‡ºç°é”™è¯¯: {e}")
    
    def _get_token(self) -> Optional[str]:
        """è·å–Access Token"""
        if self.token and time.time() < self.token_expiry:
            return self.token
            
        try:
            response = requests.post(
                f"{self.base_url}/get_token",
                json={"api_key": self.api_key, "api_secret": self.api_secret},
                timeout=10
            )
            
            if response.status_code == 200:
                data = response.json()
                if data.get("status") == 0 and "result" in data:
                    self.token = data["result"]["access_token"]
                    self.token_expiry = time.time() + data["result"]["expires_in"] - 300
                    return self.token
        except Exception as e:
            print(f"è·å–Tokenå¤±è´¥: {e}")
            
        return None
    
    def ask(self, question: str) -> str:
        """
        å‘æ™ºèƒ½ä½“æé—®ï¼ˆä½¿ç”¨å·²åˆ›å»ºçš„ä¼šè¯ï¼‰
        
        Args:
            question: é—®é¢˜å†…å®¹
            
        Returns:
            æ™ºèƒ½ä½“çš„å›ç­”
        """
        if not self.session_started or not self.conversation_id:
            return "âŒ æ¸¸æˆä¼šè¯æœªå°±ç»ªï¼Œè¯·é‡æ–°å¯åŠ¨ç¨‹åº"
        
        # 1. è·å–token
        token = self._get_token()
        if not token:
            return "âŒ æ— æ³•è·å–è®¿é—®ä»¤ç‰Œ"
        
        # 2. å‡†å¤‡è¯·æ±‚æ•°æ®ï¼ˆä½¿ç”¨å·²æœ‰çš„conversation_idä¿æŒè¿ç»­å¯¹è¯ï¼‰
        data = {
            "assistant_id": self.assistant_id,
            "prompt": question,
            "conversation_id": self.conversation_id
        }
        
        # 3. å‘é€è¯·æ±‚
        try:
            response = requests.post(
                f"{self.base_url}/stream_sync",
                headers={
                    "Authorization": f"Bearer {token}",
                    "Content-Type": "application/json"
                },
                json=data,
                timeout=30
            )
            
            if response.status_code == 200:
                result = response.json()
                
                if result.get("status") == 0:
                    # è§£æå“åº”å†…å®¹
                    result_data = result.get("result", {})
                    output_data = result_data.get("output", [])
                    texts = []
                    
                    for item in output_data:
                        contents = item.get("content", [])
                        for content in contents:
                            text = content.get("text", "")
                            if text:
                                texts.append(text)
                    
                    return "\n".join(texts) if texts else "ï¼ˆæ— æ–‡æœ¬å›å¤ï¼‰"
                else:
                    return f"âŒ è¯·æ±‚å¤±è´¥: {result.get('message', 'æœªçŸ¥é”™è¯¯')}"
            else:
                return f"âŒ HTTPé”™è¯¯: {response.status_code}"
                
        except Exception as e:
            return f"âŒ è¯·æ±‚å¼‚å¸¸: {str(e)}"


def main():
    """ä¸»å‡½æ•° - äº¤äº’å¼èŠå¤©"""
    print("=" * 60)
    print("ğŸ® æµ·é¾Ÿæ±¤æ¨ç†æ¸¸æˆ")
    print("=" * 60)
    
    # ============ é…ç½®ä¿¡æ¯ ============
    API_KEY = "dba39ba556a621b9"
    API_SECRET = "679c8b2d0addc4534a9cb2716cd2e62b"
    ASSISTANT_ID = "66c8622fbda33842f88580d0"
    # ================================
    
    try:
        # åˆ›å»ºæ™ºèƒ½ä½“å®ä¾‹ï¼ˆä¼šè‡ªåŠ¨åˆå§‹åŒ–ä¼šè¯ï¼‰
        assistant = ChatGLMAssistant(API_KEY, API_SECRET, ASSISTANT_ID)
        
        if not assistant.session_started:
            print("âŒ æ¸¸æˆåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®åé‡è¯•")
            return
        
        print("\nğŸ’¡ æ¸¸æˆè¯´æ˜:")
        print("  - æˆ‘æ˜¯æ¸¸æˆä¸»æŒäººï¼Œä¼šç»™å‡ºä¸€ä¸ªè°œé¢˜ï¼ˆæ±¤é¢ï¼‰")
        print("  - ä½ å¯ä»¥é€šè¿‡æé—®æ¥è·å–çº¿ç´¢ã€æç¤ºã€ç­”æ¡ˆ")
        print("  - å½“ä½ è®¤ä¸ºçŸ¥é“ç­”æ¡ˆæ—¶ï¼Œå¯ä»¥ç›´æ¥è¯´å‡ºç­”æ¡ˆ")
        print("  - è¾“å…¥ '/quit' å¯ä»¥éšæ—¶ç»“æŸæ¸¸æˆ")
        print("-" * 60)
        print("ğŸ¤ ç°åœ¨ï¼Œè¯·è¾“å…¥æ¸¸æˆå¼€å§‹ï¼Œå¹¶é€‰æ‹©éš¾åº¦å’Œå‰§æƒ…")
        print("=" * 60)
        
        while True:
            try:
                # è·å–ç”¨æˆ·è¾“å…¥
                user_input = input("\n ä½ : ").strip()
                
                # å¤„ç†é€€å‡ºå‘½ä»¤
                if user_input.lower() in ['/quit', '/exit', 'quit', 'exit', 'é€€å‡º']:
                    print("\næ„Ÿè°¢æ¸¸ç©ï¼å†è§ï¼")
                    break
                
                # å¤„ç†å¸®åŠ©å‘½ä»¤
                if user_input.lower() in ['/help', '/?', 'å¸®åŠ©']:
                    print("æ™ºèƒ½ä½“è®¾ç½®\nç”¨æˆ·è¯´æµ·é¾Ÿæ±¤çš„ç±»å‹å’Œ\"å¼€å§‹æ¸¸æˆ\"çš„æ—¶å€™ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæµ·é¾Ÿæ±¤ï¼Œè¾“å‡ºæ±¤é¢ï¼Œç”¨æˆ·å¼€å§‹æé—®\n##å›ç­”è¦æ±‚:\næ¯æ¬¡æ ¹æ®ç”¨æˆ·çš„é—®é¢˜å›ç­”æ­£ç¡®çš„ç­”æ¡ˆï¼Œ\nå¦‚æœç”¨æˆ·æƒ³è¦\"æç¤º\"ï¼Œå¯ä»¥é€‚å½“çš„ç»™å‡ºä¸€äº›æç¤º;\nå¦‚æœç”¨æˆ·æŠŠæµ·å¸¦æ±¤çš„æ±¤åº•è§£å†³çš„åˆ°90%çš„æ—¶å€™ç”¨æˆ·æƒ³è¦\"ç­”æ¡ˆ\"åˆ™æŠŠæ­£ç¡®ç­”æ¡ˆå‘Šè¯‰ä»–ã€‚\n##ç±»å‹åŒ…æ‹¬:\nç®€å•(é¸³é¸¯é”…)ï¼Œä¸­ç­‰éš¾åº¦ï¼Œå¤æ‚ï¼ˆé»‘é”…ï¼‰;\nææ€–ï¼Œæ™®é€šï¼Œçˆ±æƒ…;\n")
                    continue
                
                # å¿½ç•¥ç©ºè¾“å…¥
                if not user_input:
                    continue
                
                # æ˜¾ç¤ºç­‰å¾…æç¤º
                print(" æ™ºèƒ½ä½“: ", end="", flush=True)
                
                # è·å–æ™ºèƒ½ä½“å›å¤
                response = assistant.ask(user_input)
                print(response)
                
            except KeyboardInterrupt:
                print("\n\nğŸ›‘ æ¸¸æˆè¢«ä¸­æ–­")
                break
            except Exception as e:
                print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {str(e)}")
                
    except Exception as e:
        print(f"\nâŒ ç¨‹åºå¯åŠ¨å¤±è´¥: {str(e)}")
        print("è¯·æ£€æŸ¥:")
        print("1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸")
        print("2. APIé…ç½®æ˜¯å¦æ­£ç¡®")
        print("3. æ™ºèƒ½ä½“æ˜¯å¦å¯ç”¨")


# ç›´æ¥è¿è¡Œä¸»å‡½æ•°
if __name__ == "__main__":
    main()</code></pre>
            </details>
        </div>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function wait(islod, chyt) {
                const interval = setInterval(() => {
                    if (islod()) {
                        document.title = chyt;
                        clearInterval(interval);
                    }
                }, 100);
            }
            wait(
                () => document.readyState === 'complete',
                'æ¸¸æˆ|æµ·é¾Ÿæ±¤'
            );
        });
    </script>
</body>

</html>
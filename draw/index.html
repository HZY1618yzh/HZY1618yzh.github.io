<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>冬日绘版-HZY</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script>document.title = 'Loding... 冬日绘版-HZY';</script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/sidebar.css" crossorigin="anonymous">
    <script src="/js/sidebar.js"></script>
    <link rel="icon" href="https://cdn.luogu.com.cn/upload/usericon/1394471.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        .link-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            transition: transform 0.3s;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .link-card a {
            position: relative;
            z-index: 1;
            color: black !important;
            font-weight: bold;
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .link-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .center {
            text-align: center;
        }

        /* 画布样式 */
        .canvas-container {
            position: relative;
            margin: 20px auto;
            border: 2px solid #333;
            border-radius: 5px;
            overflow: hidden;
            background: #fff;
            width: 800px;
            height: 600px;
            cursor: grab;
        }

        #pixelCanvas {
            display: block;
        }

        .tools-panel {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tool-btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tool-btn.active {
            background: #4CAF50;
            color: white;
        }

        .tool-btn:hover {
            background: #e0e0e0;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: 2px solid #333;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            vertical-align: middle;
        }

        .status-bar {
            background: white;
            padding: 10px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            font-family: monospace;
        }

        .help-text {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .view-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .view-btn {
            padding: 5px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-btn:hover {
            background: #f0f0f0;
        }

        .pixel-info {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>

<body>
    <div id="nav"></div>
    <main style="padding: 20px;">
        <div class="link-card">
            <h2 class="center">欢迎来到 冬日绘版-HZY</h2>
            <p class="center">10万×10万像素画板</p>
            <p class="center pixel-info">每个像素点代表实际1个像素，无需缩放</p>
        </div>

        <div class="tools-panel">
            <h3>工具</h3>
            <button class="tool-btn active" id="brushBtn">画笔</button>
            <button class="tool-btn" id="eraserBtn">橡皮擦</button>
            <input type="color" id="colorPicker" class="color-picker" value="#000000">
            <span>取色器选择颜色</span>

            <div class="view-controls">
                <button class="view-btn" id="centerBtn">回到中心</button>
                <button class="view-btn" id="saveViewBtn">保存当前位置</button>
                <button class="view-btn" id="loadViewBtn">加载位置</button>
            </div>

            <div class="help-text">
                <p>• 左键拖动：绘制/擦除</p>
                <p>• 右键拖动：移动画布</p>
                <p>• 或者按住空格键+左键拖动：移动画布</p>
                <p>• 画布移动模式：按住右键或空格键时拖动</p>
            </div>
        </div>

        <div class="canvas-container" id="canvasContainer">
            <canvas id="pixelCanvas" width="800" height="600"></canvas>
        </div>

        <div class="status-bar">
            <p>坐标: <span id="coordDisplay">(50000000, 50000000)</span></p>
            <p>工具: <span id="toolDisplay">画笔</span></p>
            <p>颜色: <span id="colorDisplay">#000000</span></p>
            <p>状态: <span id="statusDisplay">就绪</span></p>
            <p>可见区域: <span id="viewArea">(49999600,49999700)-(50000400,50000300)</span></p>
            <p>操作模式: <span id="modeDisplay">绘画</span></p>
            <p>移动中: <span id="moveStatus">否</span></p>
        </div>

        <div class="link-card">
            <h3>说明</h3>
            <p>• 左键拖动进行连续绘制</p>
            <p>• 使用取色器（颜色选择器）选择颜色，默认黑色</p>
            <p>• 橡皮擦会从数据库中删除像素记录</p>
            <p>• 右键拖动或空格+左键拖动：移动画布</p>
            <p>• 每30秒自动从服务器获取更新</p>
            <p>• 画布大小：10万×10万像素</p>
            <p>• 固定缩放：1:1（每个像素点对应实际1个像素）</p>
            <p>• 画布移动：按住右键或空格键+左键拖动</p>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // 配置
        var SUPABASE_URL = 'https://idfnubsvhqdmsiycjgof.supabase.co';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkZm51YnN2aHFkbXNpeWNqZ29mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NjE0NjUsImV4cCI6MjA4MzUzNzQ2NX0.a6X9e_rnOv33JMN7g7OIm5TlGIXQLWlO5hR0BjOuVYU';

        // 画板参数 - 移除缩放相关参数
        var CANVAS_WIDTH = 800;
        var CANVAS_HEIGHT = 600;
        var PIXEL_SIZE = 1; // 固定像素大小
        var WORLD_SIZE = 100000;
        
        // 计算可见区域大小（像素数）
        var VISIBLE_WIDTH = Math.floor(CANVAS_WIDTH / PIXEL_SIZE); // 800像素
        var VISIBLE_HEIGHT = Math.floor(CANVAS_HEIGHT / PIXEL_SIZE); // 600像素

        // 状态变量 - 简化，移除缩放相关
        var currentTool = 'brush';
        var currentColor = '#000000';
        var offsetX = 0; // 初始居中
        var offsetY = 0;
        var updateInterval;
        var pixelCache = {};
        var isInitialLoad = true;
        var isDragging = false;
        var isSpacePressed = false;
        var isRightMouseDown = false;
        var lastMouseX = 0;
        var lastMouseY = 0;
        var isDrawing = false;
        var lastDrawX = -1;
        var lastDrawY = -1;

        // DOM元素
        var canvas = document.getElementById('pixelCanvas');
        var ctx = canvas.getContext('2d');
        var canvasContainer = document.getElementById('canvasContainer');
        var brushBtn = document.getElementById('brushBtn');
        var eraserBtn = document.getElementById('eraserBtn');
        var colorPicker = document.getElementById('colorPicker');
        var coordDisplay = document.getElementById('coordDisplay');
        var toolDisplay = document.getElementById('toolDisplay');
        var colorDisplay = document.getElementById('colorDisplay');
        var statusDisplay = document.getElementById('statusDisplay');
        var viewAreaDisplay = document.getElementById('viewArea');
        var modeDisplay = document.getElementById('modeDisplay');
        var moveStatus = document.getElementById('moveStatus');
        var centerBtn = document.getElementById('centerBtn');
        var saveViewBtn = document.getElementById('saveViewBtn');
        var loadViewBtn = document.getElementById('loadViewBtn');

        // 创建Supabase客户端
        var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 工具函数 - 简化版本
        function getVisibleArea() {
            var startX = offsetX - Math.floor(VISIBLE_WIDTH / 2);
            var endX = startX + VISIBLE_WIDTH;
            var startY = offsetY - Math.floor(VISIBLE_HEIGHT / 2);
            var endY = startY + VISIBLE_HEIGHT;
            
            return {
                startX: Math.max(0, startX),
                endX: Math.min(endX, WORLD_SIZE),
                startY: Math.max(0, startY),
                endY: Math.min(endY, WORLD_SIZE),
                width: VISIBLE_WIDTH,
                height: VISIBLE_HEIGHT
            };
        }

        function worldToCanvas(worldX, worldY) {
            var area = getVisibleArea();
            
            var canvasX = (worldX - area.startX) * PIXEL_SIZE;
            var canvasY = (worldY - area.startY) * PIXEL_SIZE;
            
            return { x: canvasX, y: canvasY };
        }

        function canvasToWorld(canvasX, canvasY) {
            var area = getVisibleArea();
            
            var worldX = area.startX + Math.floor(canvasX / PIXEL_SIZE);
            var worldY = area.startY + Math.floor(canvasY / PIXEL_SIZE);
            
            return {
                worldX: Math.max(0, Math.min(worldX, WORLD_SIZE - 1)),
                worldY: Math.max(0, Math.min(worldY, WORLD_SIZE - 1)),
                gridX: Math.floor(canvasX / PIXEL_SIZE),
                gridY: Math.floor(canvasY / PIXEL_SIZE)
            };
        }

        // 初始化
        function init() {
            // 事件监听
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            // 鼠标事件
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('mouseleave', handleMouseUp);
            
            // 右键菜单阻止
            canvas.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // 触摸事件
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd);
            
            // 工具按钮
            brushBtn.addEventListener('click', function() {
                setTool('brush');
                updateModeDisplay();
            });
            
            eraserBtn.addEventListener('click', function() {
                setTool('eraser');
                updateModeDisplay();
            });
            
            // 颜色选择器
            colorPicker.addEventListener('change', function(e) {
                currentColor = e.target.value;
                colorDisplay.textContent = currentColor;
            });
            
            // 视图控制按钮
            centerBtn.addEventListener('click', centerView);
            saveViewBtn.addEventListener('click', saveView);
            loadViewBtn.addEventListener('click', loadView);
            
            // 初始加载
            clearCanvas();
            loadCanvasData();
            
            // 定期更新
            updateInterval = setInterval(loadCanvasData, 30000);
            
            // 更新显示
            updateViewAreaDisplay();
            updateModeDisplay();
        }

        function clearCanvas() {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        }

        function setTool(tool) {
            currentTool = tool;
            
            brushBtn.classList.remove('active');
            eraserBtn.classList.remove('active');
            
            if (tool === 'brush') {
                brushBtn.classList.add('active');
                toolDisplay.textContent = '画笔';
            } else if (tool === 'eraser') {
                eraserBtn.classList.add('active');
                toolDisplay.textContent = '橡皮擦';
            }
        }

        function updateModeDisplay() {
            if (isSpacePressed || isRightMouseDown) {
                modeDisplay.textContent = '移动画布';
                canvasContainer.style.cursor = isDragging ? 'grabbing' : 'grab';
            } else {
                modeDisplay.textContent = '绘画';
                canvasContainer.style.cursor = currentTool === 'eraser' ? 'crosshair' : 'crosshair';
            }
        }

        function updateViewAreaDisplay() {
            var area = getVisibleArea();
            viewAreaDisplay.textContent = 
                `(${area.startX},${area.startY})-(${area.endX},${area.endY})`;
        }

        // 键盘事件
        function handleKeyDown(e) {
            if (e.code === 'Space') {
                isSpacePressed = true;
                updateModeDisplay();
                e.preventDefault();
            }
        }

        function handleKeyUp(e) {
            if (e.code === 'Space') {
                isSpacePressed = false;
                updateModeDisplay();
            }
        }

        // 鼠标事件
        function handleMouseDown(e) {
            e.preventDefault();
            
            var rect = canvas.getBoundingClientRect();
            var x = e.clientX - rect.left;
            var y = e.clientY - rect.top;
            
            // 检查是否在移动模式
            var isMoveMode = isSpacePressed || e.button === 2; // 右键或空格
            
            if (isMoveMode) {
                // 移动画布模式
                isDragging = true;
                isRightMouseDown = (e.button === 2);
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                moveStatus.textContent = '是';
                updateModeDisplay();
                return;
            }
            
            if (e.button === 0) { // 左键且不是移动模式
                // 绘画模式
                var pos = canvasToWorld(x, y);
                isDrawing = true;
                drawPixel(pos.worldX, pos.worldY);
                lastDrawX = pos.worldX;
                lastDrawY = pos.worldY;
            }
        }

        function handleMouseMove(e) {
            e.preventDefault();
            
            var rect = canvas.getBoundingClientRect();
            var x = e.clientX - rect.left;
            var y = e.clientY - rect.top;
            var pos = canvasToWorld(x, y);
            
            // 更新坐标显示
            coordDisplay.textContent = '(' + pos.worldX + ', ' + pos.worldY + ')';
            
            // 检查是否在移动模式
            var isMoveMode = isSpacePressed || isRightMouseDown;
            
            if (isDragging && isMoveMode) {
                // 移动画布
                var deltaX = e.clientX - lastMouseX;
                var deltaY = e.clientY - lastMouseY;
                
                // 移动偏移量（每个像素对应1个世界单位）
                offsetX -= Math.round(deltaX / PIXEL_SIZE);
                offsetY -= Math.round(deltaY / PIXEL_SIZE);
                
                // 边界检查
                offsetX = Math.max(Math.floor(VISIBLE_WIDTH / 2), 
                                 Math.min(offsetX, WORLD_SIZE - 1 - Math.floor(VISIBLE_WIDTH / 2)));
                offsetY = Math.max(Math.floor(VISIBLE_HEIGHT / 2), 
                                 Math.min(offsetY, WORLD_SIZE - 1 - Math.floor(VISIBLE_HEIGHT / 2)));
                
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                
                // 重新加载画布
                loadCanvasData();
                updateViewAreaDisplay();
            }
            
            if (isDrawing && e.buttons === 1 && !isMoveMode) {
                // 连续绘制
                if (lastDrawX !== pos.worldX || lastDrawY !== pos.worldY) {
                    drawLine(lastDrawX, lastDrawY, pos.worldX, pos.worldY);
                    lastDrawX = pos.worldX;
                    lastDrawY = pos.worldY;
                }
            }
        }

        function handleMouseUp(e) {
            if (isDragging) {
                isDragging = false;
                if (e.button === 2) {
                    isRightMouseDown = false;
                }
                moveStatus.textContent = '否';
                updateModeDisplay();
            }
            
            if (isDrawing) {
                isDrawing = false;
                lastDrawX = -1;
                lastDrawY = -1;
            }
        }

        // 绘制函数
        function drawLine(x1, y1, x2, y2) {
            var dx = Math.abs(x2 - x1);
            var dy = Math.abs(y2 - y1);
            var sx = (x1 < x2) ? 1 : -1;
            var sy = (y1 < y2) ? 1 : -1;
            var err = dx - dy;
            
            var currentX = x1;
            var currentY = y1;
            
            while (true) {
                drawPixel(currentX, currentY);
                
                if (currentX === x2 && currentY === y2) break;
                var e2 = 2 * err;
                if (e2 > -dy) {
                    err -= dy;
                    currentX += sx;
                }
                if (e2 < dx) {
                    err += dx;
                    currentY += sy;
                }
            }
        }

        function drawPixel(worldX, worldY) {
            if (worldX < 0 || worldX >= WORLD_SIZE || worldY < 0 || worldY >= WORLD_SIZE) return;
            
            var color, colorNum;
            if (currentTool === 'eraser') {
                color = '#FFFFFF';
                colorNum = null;
            } else {
                color = currentColor;
                colorNum = parseInt(color.replace('#', ''), 16);
            }
            
            // 绘制到画布
            var canvasPos = worldToCanvas(worldX, worldY);
            
            if (canvasPos.x >= 0 && canvasPos.x < CANVAS_WIDTH && 
                canvasPos.y >= 0 && canvasPos.y < CANVAS_HEIGHT) {
                
                ctx.fillStyle = color;
                ctx.fillRect(canvasPos.x, canvasPos.y, PIXEL_SIZE, PIXEL_SIZE);
            }
            
            // 更新缓存
            var key = worldX + ',' + worldY;
            if (currentTool === 'eraser') {
                delete pixelCache[key];
            } else {
                pixelCache[key] = color;
            }
            
            // 保存到数据库
            savePixelToDatabase(worldX, worldY, colorNum);
        }

        function savePixelToDatabase(worldX, worldY, colorNum) {
            var id = worldX * 100000 + worldY;
            
            if (colorNum === null) {
                // 删除像素
                supabase
                    .from('draw')
                    .delete()
                    .eq('id', id)
                    .then(function(response) {
                        if (response.error) {
                            console.error('删除像素失败:', response.error);
                            statusDisplay.textContent = '删除失败';
                        } else {
                            statusDisplay.textContent = '已删除';
                            setTimeout(function() {
                                statusDisplay.textContent = '就绪';
                            }, 1000);
                        }
                    })
                    .catch(function(error) {
                        console.error('删除错误:', error);
                        statusDisplay.textContent = '错误';
                    });
            } else {
                // 更新或插入像素
                supabase
                    .from('draw')
                    .upsert({
                        id: id,
                        col: colorNum
                    }, {
                        onConflict: 'id'
                    })
                    .then(function(response) {
                        if (response.error) {
                            console.error('保存像素失败:', response.error);
                            statusDisplay.textContent = '保存失败';
                        } else {
                            statusDisplay.textContent = '已保存';
                            setTimeout(function() {
                                statusDisplay.textContent = '就绪';
                            }, 1000);
                        }
                    })
                    .catch(function(error) {
                        console.error('保存错误:', error);
                        statusDisplay.textContent = '错误';
                    });
            }
        }

        function loadCanvasData() {
            if (isInitialLoad) {
                statusDisplay.textContent = '加载中...';
            }
            
            var area = getVisibleArea();
            
            clearCanvas();
            
            // 从缓存绘制可见区域内的像素
            Object.keys(pixelCache).forEach(function(key) {
                var parts = key.split(',');
                var worldX = parseInt(parts[0]);
                var worldY = parseInt(parts[1]);
                
                if (worldX >= area.startX && worldX < area.endX && 
                    worldY >= area.startY && worldY < area.endY) {
                    
                    var canvasPos = worldToCanvas(worldX, worldY);
                    ctx.fillStyle = pixelCache[key];
                    ctx.fillRect(canvasPos.x, canvasPos.y, PIXEL_SIZE, PIXEL_SIZE);
                }
            });
            
            // 从数据库加载新数据
            var minId = area.startX * 100000 + area.startY;
            var maxId = area.endX * 100000 + area.endY;
            
            supabase
                .from('draw')
                .select('id, col')
                .gte('id', minId)
                .lt('id', maxId)
                .then(function(response) {
                    if (response.data) {
                        response.data.forEach(function(pixel) {
                            var id = pixel.id;
                            var worldY = id % 100000;
                            var worldX = (id - worldY) / 100000;
                            
                            // 绘制像素
                            var canvasPos = worldToCanvas(worldX, worldY);
                            var color = '#' + pixel.col.toString(16).padStart(6, '0');
                            
                            ctx.fillStyle = color;
                            ctx.fillRect(canvasPos.x, canvasPos.y, PIXEL_SIZE, PIXEL_SIZE);
                            
                            // 更新缓存
                            var key = worldX + ',' + worldY;
                            pixelCache[key] = color;
                        });
                        
                        if (isInitialLoad) {
                            statusDisplay.textContent = '加载完成';
                            isInitialLoad = false;
                            setTimeout(function() {
                                statusDisplay.textContent = '就绪';
                            }, 1000);
                        }
                    }
                    
                    updateViewAreaDisplay();
                })
                .catch(function(error) {
                    console.error('加载像素失败:', error);
                    statusDisplay.textContent = '加载失败';
                });
        }

        // 视图控制函数
        function centerView() {
            offsetX = 50000000;
            offsetY = 50000000;
            loadCanvasData();
            updateViewAreaDisplay();
            statusDisplay.textContent = '已回到中心';
            setTimeout(function() {
                statusDisplay.textContent = '就绪';
            }, 1000);
        }

        function saveView() {
            try {
                localStorage.setItem('paintView', JSON.stringify({
                    offsetX: offsetX,
                    offsetY: offsetY,
                    timestamp: Date.now()
                }));
                statusDisplay.textContent = '位置已保存';
                setTimeout(function() {
                    statusDisplay.textContent = '就绪';
                }, 1000);
            } catch (e) {
                statusDisplay.textContent = '保存失败';
            }
        }

        function loadView() {
            try {
                var saved = localStorage.getItem('paintView');
                if (saved) {
                    var view = JSON.parse(saved);
                    offsetX = view.offsetX || 50000000;
                    offsetY = view.offsetY || 50000000;
                    loadCanvasData();
                    updateViewAreaDisplay();
                    statusDisplay.textContent = '位置已加载';
                    setTimeout(function() {
                        statusDisplay.textContent = '就绪';
                    }, 1000);
                } else {
                    statusDisplay.textContent = '无保存的位置';
                }
            } catch (e) {
                statusDisplay.textContent = '加载失败';
            }
        }

        // 触摸事件处理
        function handleTouchStart(e) {
            if (e.touches.length === 1) {
                e.preventDefault();
                var touch = e.touches[0];
                var rect = canvas.getBoundingClientRect();
                var x = touch.clientX - rect.left;
                var y = touch.clientY - rect.top;
                
                // 单指触摸开始绘画
                var pos = canvasToWorld(x, y);
                isDrawing = true;
                drawPixel(pos.worldX, pos.worldY);
                lastDrawX = pos.worldX;
                lastDrawY = pos.worldY;
            } else if (e.touches.length === 2) {
                // 双指触摸用于移动
                e.preventDefault();
                isDragging = true;
                moveStatus.textContent = '是';
                modeDisplay.textContent = '移动画布';
                canvasContainer.style.cursor = 'grabbing';
            }
        }

        function handleTouchMove(e) {
            if (e.touches.length === 1 && isDrawing) {
                e.preventDefault();
                var touch = e.touches[0];
                var rect = canvas.getBoundingClientRect();
                var x = touch.clientX - rect.left;
                var y = touch.clientY - rect.top;
                var pos = canvasToWorld(x, y);
                coordDisplay.textContent = '(' + pos.worldX + ', ' + pos.worldY + ')';
                
                if (lastDrawX !== pos.worldX || lastDrawY !== pos.worldY) {
                    drawLine(lastDrawX, lastDrawY, pos.worldX, pos.worldY);
                    lastDrawX = pos.worldX;
                    lastDrawY = pos.worldY;
                }
            } else if (e.touches.length === 2 && isDragging) {
                e.preventDefault();
                // 双指移动画布 - 使用两指中心点
                var touch1 = e.touches[0];
                var touch2 = e.touches[1];
                
                var centerX = (touch1.clientX + touch2.clientX) / 2;
                var centerY = (touch1.clientY + touch2.clientY) / 2;
                
                if (lastMouseX !== 0 && lastMouseY !== 0) {
                    var deltaX = centerX - lastMouseX;
                    var deltaY = centerY - lastMouseY;
                    
                    offsetX -= Math.round(deltaX / PIXEL_SIZE);
                    offsetY -= Math.round(deltaY / PIXEL_SIZE);
                    
                    // 边界检查
                    offsetX = Math.max(Math.floor(VISIBLE_WIDTH / 2), 
                                     Math.min(offsetX, WORLD_SIZE - 1 - Math.floor(VISIBLE_WIDTH / 2)));
                    offsetY = Math.max(Math.floor(VISIBLE_HEIGHT / 2), 
                                     Math.min(offsetY, WORLD_SIZE - 1 - Math.floor(VISIBLE_HEIGHT / 2)));
                    
                    loadCanvasData();
                    updateViewAreaDisplay();
                }
                
                lastMouseX = centerX;
                lastMouseY = centerY;
            }
        }

        function handleTouchEnd(e) {
            if (e.touches.length === 0) {
                isDrawing = false;
                isDragging = false;
                lastDrawX = -1;
                lastDrawY = -1;
                lastMouseX = 0;
                lastMouseY = 0;
                moveStatus.textContent = '否';
                modeDisplay.textContent = '绘画';
                canvasContainer.style.cursor = 'grab';
            }
        }

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            // 等待页面完全加载
            function wait(condition, callback) {
                var interval = setInterval(function() {
                    if (condition()) {
                        callback();
                        clearInterval(interval);
                    }
                }, 100);
            }
            
            init();
            
            wait(
                function() { return document.readyState === 'complete'; },
                function() {
                    document.title = '冬日绘版-HZY';
                }
            );
        });
    </script>
</body>

</html>
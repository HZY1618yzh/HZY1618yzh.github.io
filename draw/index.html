<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>冬日绘版-HZY</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script>document.title = 'Loding... 冬日绘版-HZY';</script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://cdn.luogu.com.cn/upload/usericon/1394471.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        .link-card {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            transition: transform 0.3s;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .link-card a {
            position: relative;
            z-index: 1;
            color: black !important;
            font-weight: bold;
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .link-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .center {
            text-align: center;
        }

        /* 画布样式 */
        .canvas-container {
            position: relative;
            margin: 20px auto;
            border: 2px solid #333;
            border-radius: 5px;
            overflow: hidden;
            background: #fff;
            width: 800px;
            height: 600px;
        }

        #pixelCanvas {
            display: block;
            cursor: crosshair;
        }

        .tools-panel {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .tool-btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tool-btn.active {
            background: #4CAF50;
            color: white;
        }

        .tool-btn:hover {
            background: #e0e0e0;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: 2px solid #333;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            vertical-align: middle;
        }

        .status-bar {
            background: white;
            padding: 10px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            font-family: monospace;
        }

        .help-text {
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .view-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .view-btn {
            padding: 5px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-btn:hover {
            background: #f0f0f0;
        }

        .pixel-info {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>

<body>
    <div id="nav"></div>
    <main style="padding: 20px;">
        <div class="link-card">
            <h2 class="center">冬日绘版-HZY</h2>
            <p class="center">1万×1万像素画板</p>
            <p class="center pixel-info">不卡顿了</p>
        </div>

        <div class="tools-panel">
            <h3>工具</h3>
            <button class="tool-btn active" id="brushBtn">画笔</button>
            <button class="tool-btn" id="eraserBtn">橡皮擦</button>
            <input type="color" id="colorPicker" class="color-picker" value="#000000">
            <span>颜色选择</span>

            <div class="view-controls">
                <button class="view-btn" id="centerBtn">回到中心</button>
                <button class="view-btn" id="saveViewBtn">保存位置</button>
                <button class="view-btn" id="loadViewBtn">加载位置</button>
            </div>

            <div class="help-text">
                <p>• 左键拖动：绘制/擦除</p>
                <p>• 右键拖动：移动画布</p>
                <p>• 空格+左键：移动画布</p>
            </div>
        </div>

        <div class="canvas-container" id="canvasContainer">
            <canvas id="pixelCanvas" width="800" height="600"></canvas>
        </div>

        <div class="status-bar">
            <p>坐标: <span id="coordDisplay">(5000, 5000)</span></p>
            <p>工具: <span id="toolDisplay">画笔</span></p>
            <p>颜色: <span id="colorDisplay">#000000</span></p>
            <p>状态: <span id="statusDisplay">就绪</span></p>
        </div>

        <div class="link-card">
            <h3>操作说明</h3>
            <p>1. 点击"画笔"或"橡皮擦"切换工具</p>
            <p>2. 在画布上左键点击或拖动绘制</p>
            <p>3. 右键拖动或空格+左键拖动移动画布</p>
            <p>4. 使用颜色选择器选择颜色</p>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // 配置
        var SUPABASE_URL = 'https://idfnubsvhqdmsiycjgof.supabase.co';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkZm51YnN2aHFkbXNpeWNqZ29mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NjE0NjUsImV4cCI6MjA4MzUzNzQ2NX0.a6X9e_rnOv33JMN7g7OIm5TlGIXQLWlO5hR0BjOuVYU';

        // 画板参数
        var CANVAS_WIDTH = 800;
        var CANVAS_HEIGHT = 600;
        var PIXEL_SIZE = 1;
        var WORLD_SIZE = 10000;
        
        var VISIBLE_WIDTH = CANVAS_WIDTH;
        var VISIBLE_HEIGHT = CANVAS_HEIGHT;

        // 状态变量
        var currentTool = 'brush';
        var currentColor = '#000000';
        var offsetX = 5000;
        var offsetY = 5000;
        var updateInterval;
        var isDragging = false;
        var isSpacePressed = false;
        var isRightMouseDown = false;
        var lastMouseX = 0;
        var lastMouseY = 0;
        var isDrawing = false;
        var lastDrawX = -1;
        var lastDrawY = -1;

        // DOM元素
        var canvas = document.getElementById('pixelCanvas');
        var ctx = canvas.getContext('2d');
        var canvasContainer = document.getElementById('canvasContainer');
        var brushBtn = document.getElementById('brushBtn');
        var eraserBtn = document.getElementById('eraserBtn');
        var colorPicker = document.getElementById('colorPicker');
        var coordDisplay = document.getElementById('coordDisplay');
        var toolDisplay = document.getElementById('toolDisplay');
        var colorDisplay = document.getElementById('colorDisplay');
        var statusDisplay = document.getElementById('statusDisplay');

        // 创建Supabase客户端
        var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 工具函数
        function getVisibleArea() {
            var startX = offsetX - Math.floor(VISIBLE_WIDTH / 2);
            var endX = startX + VISIBLE_WIDTH;
            var startY = offsetY - Math.floor(VISIBLE_HEIGHT / 2);
            var endY = startY + VISIBLE_HEIGHT;
            
            return {
                startX: Math.max(0, startX),
                endX: Math.min(endX, WORLD_SIZE),
                startY: Math.max(0, startY),
                endY: Math.min(endY, WORLD_SIZE)
            };
        }

        function worldToCanvas(worldX, worldY) {
            var area = getVisibleArea();
            var canvasX = (worldX - area.startX) * PIXEL_SIZE;
            var canvasY = (worldY - area.startY) * PIXEL_SIZE;
            return { x: canvasX, y: canvasY };
        }

        function canvasToWorld(canvasX, canvasY) {
            var area = getVisibleArea();
            var worldX = area.startX + Math.floor(canvasX / PIXEL_SIZE);
            var worldY = area.startY + Math.floor(canvasY / PIXEL_SIZE);
            
            return {
                worldX: Math.max(0, Math.min(worldX, WORLD_SIZE - 1)),
                worldY: Math.max(0, Math.min(worldY, WORLD_SIZE - 1))
            };
        }

        // 初始化
        function init() {
            console.log("初始化开始");
            
            // 事件监听
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('mouseleave', handleMouseUp);
            
            canvas.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            });
            
            // 工具按钮事件
            brushBtn.onclick = function() {
                console.log("点击画笔按钮");
                currentTool = 'brush';
                brushBtn.classList.add('active');
                eraserBtn.classList.remove('active');
                toolDisplay.textContent = '画笔';
                canvas.style.cursor = 'crosshair';
            };
            
            eraserBtn.onclick = function() {
                console.log("点击橡皮擦按钮");
                currentTool = 'eraser';
                brushBtn.classList.remove('active');
                eraserBtn.classList.add('active');
                toolDisplay.textContent = '橡皮擦';
                canvas.style.cursor = 'crosshair';
            };
            
            // 颜色选择器
            colorPicker.onchange = function(e) {
                currentColor = e.target.value;
                colorDisplay.textContent = currentColor;
            };
            
            // 视图控制按钮
            document.getElementById('centerBtn').onclick = centerView;
            document.getElementById('saveViewBtn').onclick = saveView;
            document.getElementById('loadViewBtn').onclick = loadView;
            
            // 初始加载
            clearCanvas();
            loadCanvasData();
            
            console.log("初始化完成");
        }

        function clearCanvas() {
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        }

        // 键盘事件
        function handleKeyDown(e) {
            if (e.code === 'Space') {
                isSpacePressed = true;
                canvas.style.cursor = 'grab';
                e.preventDefault();
            }
        }

        function handleKeyUp(e) {
            if (e.code === 'Space') {
                isSpacePressed = false;
                canvas.style.cursor = 'crosshair';
            }
        }

        // 鼠标事件
        function handleMouseDown(e) {
            e.preventDefault();
            
            var rect = canvas.getBoundingClientRect();
            var x = e.clientX - rect.left;
            var y = e.clientY - rect.top;
            
            // 检查是否是移动模式
            if (isSpacePressed || e.button === 2) {
                console.log("开始移动画布");
                isDragging = true;
                isRightMouseDown = (e.button === 2);
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                canvas.style.cursor = 'grabbing';
                return;
            }
            
            if (e.button === 0) { // 左键
                console.log("开始绘制，工具:", currentTool);
                var pos = canvasToWorld(x, y);
                isDrawing = true;
                drawPixel(pos.worldX, pos.worldY);
                lastDrawX = pos.worldX;
                lastDrawY = pos.worldY;
            }
        }

        function handleMouseMove(e) {
            e.preventDefault();
            
            var rect = canvas.getBoundingClientRect();
            var x = e.clientX - rect.left;
            var y = e.clientY - rect.top;
            var pos = canvasToWorld(x, y);
            
            // 更新坐标显示
            coordDisplay.textContent = '(' + pos.worldX + ', ' + pos.worldY + ')';
            
            // 移动画布
            if (isDragging && (isSpacePressed || isRightMouseDown)) {
                var deltaX = e.clientX - lastMouseX;
                var deltaY = e.clientY - lastMouseY;
                
                offsetX -= Math.round(deltaX);
                offsetY -= Math.round(deltaY);
                
                // 边界检查
                offsetX = Math.max(Math.floor(VISIBLE_WIDTH / 2), 
                                 Math.min(offsetX, WORLD_SIZE - 1 - Math.floor(VISIBLE_WIDTH / 2)));
                offsetY = Math.max(Math.floor(VISIBLE_HEIGHT / 2), 
                                 Math.min(offsetY, WORLD_SIZE - 1 - Math.floor(VISIBLE_HEIGHT / 2)));
                
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                
                loadCanvasData();
                return;
            }
            
            // 连续绘制
            if (isDrawing && e.buttons === 1) {
                if (lastDrawX !== pos.worldX || lastDrawY !== pos.worldY) {
                    drawLine(lastDrawX, lastDrawY, pos.worldX, pos.worldY);
                    lastDrawX = pos.worldX;
                    lastDrawY = pos.worldY;
                }
            }
        }

        function handleMouseUp(e) {
            if (isDragging) {
                isDragging = false;
                if (e.button === 2) {
                    isRightMouseDown = false;
                }
                canvas.style.cursor = isSpacePressed ? 'grab' : 'crosshair';
            }
            
            if (isDrawing) {
                isDrawing = false;
                lastDrawX = -1;
                lastDrawY = -1;
            }
        }

        // 绘制函数
        function drawLine(x1, y1, x2, y2) {
            var dx = Math.abs(x2 - x1);
            var dy = Math.abs(y2 - y1);
            var sx = (x1 < x2) ? 1 : -1;
            var sy = (y1 < y2) ? 1 : -1;
            var err = dx - dy;
            
            var currentX = x1;
            var currentY = y1;
            
            while (true) {
                drawPixel(currentX, currentY);
                
                if (currentX === x2 && currentY === y2) break;
                var e2 = 2 * err;
                if (e2 > -dy) {
                    err -= dy;
                    currentX += sx;
                }
                if (e2 < dx) {
                    err += dx;
                    currentY += sy;
                }
            }
        }

        function drawPixel(worldX, worldY) {
            if (worldX < 0 || worldX >= WORLD_SIZE || worldY < 0 || worldY >= WORLD_SIZE) return;
            
            var color, colorNum;
            if (currentTool === 'eraser') {
                color = '#FFFFFF';
                colorNum = null;
                console.log("擦除像素:", worldX, worldY);
            } else {
                color = currentColor;
                colorNum = parseInt(color.replace('#', ''), 16);
                console.log("绘制像素:", worldX, worldY, "颜色:", color);
            }
            
            // 绘制到画布
            var canvasPos = worldToCanvas(worldX, worldY);
            
            if (canvasPos.x >= 0 && canvasPos.x < CANVAS_WIDTH && 
                canvasPos.y >= 0 && canvasPos.y < CANVAS_HEIGHT) {
                ctx.fillStyle = color;
                ctx.fillRect(canvasPos.x, canvasPos.y, PIXEL_SIZE, PIXEL_SIZE);
            }
            
            // 保存到数据库
            savePixelToDatabase(worldX, worldY, colorNum);
        }

        function savePixelToDatabase(worldX, worldY, colorNum) {
            var id = worldX * WORLD_SIZE + worldY;
            
            if (colorNum === null) {
                // 删除像素
                supabase
                    .from('draw')
                    .delete()
                    .eq('id', id)
                    .then(function(response) {
                        if (response.error) {
                            console.error('删除像素失败:', response.error);
                            statusDisplay.textContent = '删除失败';
                        } else {
                            statusDisplay.textContent = '已删除';
                            setTimeout(function() {
                                statusDisplay.textContent = '就绪';
                            }, 1000);
                        }
                    });
            } else {
                // 更新或插入像素
                supabase
                    .from('draw')
                    .upsert({
                        id: id,
                        col: colorNum
                    }, {
                        onConflict: 'id'
                    })
                    .then(function(response) {
                        if (response.error) {
                            console.error('保存像素失败:', response.error);
                            statusDisplay.textContent = '保存失败';
                        } else {
                            statusDisplay.textContent = '已保存';
                            setTimeout(function() {
                                statusDisplay.textContent = '就绪';
                            }, 1000);
                        }
                    });
            }
        }

        function loadCanvasData() {
            statusDisplay.textContent = '加载中...';
            
            var area = getVisibleArea();
            var minId = area.startX * WORLD_SIZE + area.startY;
            var maxId = area.endX * WORLD_SIZE + area.endY;
            
            // 清空画布
            clearCanvas();
            
            supabase
                .from('draw')
                .select('id, col')
                .gte('id', minId)
                .lt('id', maxId)
                .then(function(response) {
                    if (response.data) {
                        response.data.forEach(function(pixel) {
                            var id = pixel.id;
                            var worldY = id % WORLD_SIZE;
                            var worldX = (id - worldY) / WORLD_SIZE;
                            
                            var canvasPos = worldToCanvas(worldX, worldY);
                            var color = '#' + pixel.col.toString(16).padStart(6, '0');
                            
                            ctx.fillStyle = color;
                            ctx.fillRect(canvasPos.x, canvasPos.y, PIXEL_SIZE, PIXEL_SIZE);
                        });
                    }
                    
                    statusDisplay.textContent = '就绪';
                })
                .catch(function(error) {
                    console.error('加载像素失败:', error);
                    statusDisplay.textContent = '加载失败';
                });
        }

        // 视图控制
        function centerView() {
            offsetX = 5000;
            offsetY = 5000;
            loadCanvasData();
            statusDisplay.textContent = '已回到中心';
            setTimeout(function() {
                statusDisplay.textContent = '就绪';
            }, 1000);
        }

        function saveView() {
            try {
                localStorage.setItem('paintView', JSON.stringify({
                    offsetX: offsetX,
                    offsetY: offsetY
                }));
                statusDisplay.textContent = '位置已保存';
                setTimeout(function() {
                    statusDisplay.textContent = '就绪';
                }, 1000);
            } catch (e) {
                statusDisplay.textContent = '保存失败';
            }
        }

        function loadView() {
            try {
                var saved = localStorage.getItem('paintView');
                if (saved) {
                    var view = JSON.parse(saved);
                    offsetX = view.offsetX || 5000;
                    offsetY = view.offsetY || 5000;
                    loadCanvasData();
                    statusDisplay.textContent = '位置已加载';
                    setTimeout(function() {
                        statusDisplay.textContent = '就绪';
                    }, 1000);
                } else {
                    statusDisplay.textContent = '无保存的位置';
                }
            } catch (e) {
                statusDisplay.textContent = '加载失败';
            }
        }

        // 页面加载完成
        window.onload = function() {
            init();
            document.title = '冬日绘版-HZY';
            console.log("页面加载完成");
        };
    </script>
</body>

</html>